#-*-mode: Shell-script; coding: utf-8;-*-
# Maintainer: Mitch Tishmack <mitch.tishmack@gmail.com>
#
# Build/bootstrap ghc similarly to the go package.
# Caveat: bootstrapping isn't a commonly tested piece of ghc.
#
# Note: This only exists to build the native ghc. It is
# huge in size and slow.
pkgname=ghc-bootstrap
pkgver=8.0.1
pkgrel=0
pkgdesc="The Glasgow haskell compiler (bootstrapped)"
arch="x86_64"
arch="x86_64 armhf"
license="custom:bsd3"
url="https://haskell.org"
depends="bash libffi musl zlib gcc binutils-gold llvm3.7"
install=""
subpackages=""
makedepends=""
source="
	https://mitchty.net/ghc/8.0.1/ghc-$pkgver-x86_64.tar.xz
	https://mitchty.net/ghc/8.0.1/ghc-$pkgver-armhf.tar.xz
"

# The bootstrap process uses docker to build ghc from a debian glibc host
# then upload the bootstrap compiler to where that source url is.
#
# Ensure that docker is running prior to calling this.
#
# Note, these docker images are large, ~10G the dockerfiles weren't built
# to be small. Once built the containers should likely be removed.
snapshot() {
	for x in $(echo ${arch}); do
		docker build -t alpine-ghc-bootstrap:${x} \
			-f Dockerfile.${x} . || return 1
		docker run -a stdout alpine-ghc-bootstrap:${x} \
			/bin/cat "/tmp/ghc-${pkgver}-${arch}.tar.xz" > ghc-${pkgver}-${arch}.tar.xz || return 1
	done
}

package() {
	cd "$srcdir/$CARCH"
	install -d "$pkgdir" || return 1
	mv usr "$pkgdir" || return 1
	settings=$(find "$pkgdir" -name settings -type f)
	local settings="$(find $pkgdir -name settings -type f)"
	# Force all the pic/pie hardening off for ghc until this bug:
	# https://ghc.haskell.org/trac/ghc/ticket/9007
	# is fixed/corrected. Otherwise we end up with TEXT segments
	# in places that make no sense.
	sed -i 's/.*C compiler flags", "/& -fPIC -fno-PIE -fno-stack-protector/' "$settings"
	sed -i 's/.*ld flags", "/& -no-pie /' "$settings"
	sed -i 's|/usr/.*-gcc|gcc|' "$settings"
	sed -i 's|/usr/.*-ar|ar|' "$settings"
	sed -i 's|/usr/.*-ld.gold|ld.gold|' "$settings"
	sed -i 's|/usr/.*-ld|ld.gold|' "$settings"
	sed -i 's|/usr/.*/llc|llc-3.7|' "$settings"
	sed -i 's|/usr/.*/opt|opt-3.7|' "$settings"
}
md5sums="1a9b9c66051d44af2ed2c2acb4bccecc  ghc-8.0.1-x86_64.tar.xz
3def2a6be2063e66df71bb14e4d698f2  ghc-8.0.1-armhf.tar.xz"
sha256sums="29ddef1e27ca24eadb47367dcc00f74c01c4a6aa3de1246c654775d6fe9a6838  ghc-8.0.1-x86_64.tar.xz
9fc141e6f7335cdf05ac70fc26a1291f06e5825f819d2536eed9d485e4bce47f  ghc-8.0.1-armhf.tar.xz"
sha512sums="11cbb3ee58f9ad54b5c69ec9112b0de6d722a26e2310197bad637b5a06c098db5819d39095d2797906974165c8934c564e3a1873e864ad29f8ce293b6aa8a7c7  ghc-8.0.1-x86_64.tar.xz
4fd228df2fdf454085a19edffc37adb9827c202cc86557c35644744d92e4264fb66023d215a74e5cecb45248877cd829308c30215199ae8998d9a9c1c880e489  ghc-8.0.1-armhf.tar.xz"
