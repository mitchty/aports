# Maintainer: Mitch Tishmack <mitch.tishmack@gmail.com>
pkgname=ghc
pkgver=8.4.2
pkgrel=0
# Normal non rc candidate
urlprefix="$pkgver"
pkgprefix="$pkgname-$pkgver"
pkgdesc="The Glasgow Haskell Compiler"
# Next 5 variables only needed for release candidate testing
#pkgrcver=8.2.2
#pkgrc=rc3
#pkgdate=20171108
#urlprefix="$pkgrcver-$pkgrc"
#pkgprefix="ghc-$pkgver.$pkgdate"
url="http://haskell.org"
arch="x86_64"
# Note ghc's license is basically BSD-3. If you'd like to know more visit:
# * https://www.haskell.org/ghc/license
# * https://ghc.haskell.org/trac/ghc/wiki/Licensing
license="custom:BSD-3"
# Note that ghc is sensitive to the version of llvm used,
# hence the llvm5 dependency.
#
# Ref: https://ghc.haskell.org/trac/ghc/wiki/Status/GHC-8.0.1
#      https://ghc.haskell.org/trac/ghc/wiki/ImprovedLLVMBackend
depends="gmp-dev perl gcc>=6.2.1 llvm5 libffi-dev"
makedepends_build="ghc autoconf cpio binutils binutils-gold paxmark libffi-dev ncurses-dev xz coreutils"
makedepends_host="linux-headers musl-dev zlib-dev gmp-dev binutils-dev libffi-dev ncurses-dev"
makedepends="ghc $makedepends_build $makedepends_host"
checkdepends="python3"
subpackages="$pkgname-doc $pkgname-dev"
install="$pkgname.post-install"
options="!strip"  # we strip it manually in build()
source="https://downloads.haskell.org/~ghc/$urlprefix/$pkgprefix-src.tar.xz
        https://downloads.haskell.org/~ghc/$urlprefix/$pkgprefix-testsuite.tar.xz
        0005-buildpath-abi-stability.patch
        "

# We only need the bootstrap patch when bootstrapping a new arches ghc.
if [ "$CBUILD" != "$CTARGET" ]; then
	source="$source 0000-bootstrap.patch"
fi

builddir="$srcdir/$pkgprefix"

prepare() {
	default_prepare

	cp mk/build.mk.sample mk/build.mk

	cat >> mk/build.mk <<-EOF
		BuildFlavour         = perf-llvm
		INTEGER_LIBRARY      = integer-gmp
		BeConservative       = YES
		GhcStage3HcOpts     += -O3
		SplitSections        = YES
	EOF

	if [ "$CBUILD" != "$CTARGET" ]; then
		# cross-build
		cat >> mk/build.mk <<-EOF
			HADDOCK_DOCS         = NO
			BUILD_SPHINX_HTML    = NO
			BUILD_SPHINX_PS      = NO
			BUILD_SPHINX_PDF     = NO
		EOF
	fi
}

build() {
	# Note, 8.4.2 is now using the hadrian build system. Autoconf will
	# be removed at some future junction by upstream.

	# For more information https://ghc.haskell.org/trac/ghc/wiki/Building/Hadrian/QuickStart
	cd "$builddir"

	./hadrian/build.sh -c -j $JOBS
}

check() {
	# disabled for now
	return 0
#	cd "$builddir/testsuite"
#	make fast THREADS=$JOBS
}

doc() {
	default_doc
	install -Dm644 "$builddir/LICENSE" \
		"$subpkgdir/usr/share/licenses/$subpkgname/LICENSE"
}

package() {
	# The new build system builds relocatable by default binaries.
	# All we need to do is copy the bin and lib dirs to where they need to go.
	cp -rp "$builddir/_build/stage1/bin "$pkgdir/usr/bin"
	cp -rp "$builddir/_build/stage1/lib "$pkgdir/usr/lib"

	# Can't do a full strip on archives.
	find "$pkgdir/usr/lib" -type f \( -name "*.so" -o -name "*.a" \) \
		-exec ${CROSS_COMPILE}strip --strip-unneeded {} \;
	find $pkgdir/usr/bin -type f -exec ${CROSS_COMPILE}strip {} \;

	paxmark -m \
		$pkgdir/usr/bin/ghc \
		$pkgdir/usr/bin/ghc-iserv \
		$pkgdir/usr/bin/ghc-iserv-dyn \
		$pkgdir/usr/bin/ghc-iserv-prof
}

bindist() {
	return 0
	# binary-dist is basically the same as non binary dist
#	cd "$builddir"
#	./configure LD=ld.gold
#	make
#	make -j1 binary-dist TAR_COMP_CMD="xz -T0"
#	local bindist=$(find "$builddir" -name "*.tar.xz")
#	cp $bindist $srcdir/../$(basename $bindist)
}

# Like debian, we split apart the profiled archives/etc...
# This drastically reduces the install size of the ghc pkg.
dev() {
	pkgdesc="$pkgdesc (development files)"
	depends="$pkgname=$pkgver-r$pkgrel"

	cd "$pkgdir"

	install -dm755 "$subpkgdir"

	local pfiles=$(find . \( -type f -o -type l \) \( -name "*.p_*" -o -name "lib*_p.a" \))
	echo "$pfiles" | cpio -pamVd "$subpkgdir"
	echo "$pfiles" | xargs rm -fr
}
